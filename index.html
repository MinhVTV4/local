<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo D√µi V·ªã Tr√≠ v5.3 - C·∫£i ti·∫øn Gom Nh√≥m</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet MarkerCluster CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        html, body { height: 100%; }
        body { font-family: 'Inter', sans-serif; margin: 0; }
        .other-user-marker {
            background-color: #3b82f6; width: 1.5rem; height: 1.5rem; border-radius: 9999px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center; color: white; font-size: 0.75rem; font-weight: bold;
        }
        .current-user-marker {
            background-color: #22c55e; width: 1.75rem; height: 1.75rem; border-radius: 9999px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #map-container { position: relative; height: 100%; width: 100%; }
        #map { height: 100%; width: 100%; border-radius: 0.75rem; }
        .leaflet-pane { z-index: 1; }
        .leaflet-top, .leaflet-bottom { z-index: 2; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Auth/Welcome Screen -->
    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center p-4 text-center bg-white">
        <div class="max-w-md w-full">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Theo D√µi Nh√≥m</h1>
            <p class="text-lg text-gray-600 mb-8">T·∫°o m·ªôt nh√≥m ri√™ng t∆∞ ƒë·ªÉ chia s·∫ª v·ªã tr√≠ v·ªõi gia ƒë√¨nh v√† b·∫°n b√®.</p>
            <div class="space-y-4">
                <button id="create-group-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg disabled:bg-blue-400 disabled:cursor-not-allowed" disabled>T·∫°o Nh√≥m M·ªõi</button>
                <button id="join-group-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>Tham Gia Nh√≥m</button>
            </div>
            <p id="auth-status" class="mt-6 text-gray-500 text-sm">ƒêang k·∫øt n·ªëi...</p>
        </div>
    </div>
    
    <!-- Create Group Modal -->
    <div id="create-group-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-4">T·∫°o Nh√≥m M·ªõi</h2>
            <p class="text-gray-600 mb-4">ƒê·∫∑t m·ªôt t√™n d·ªÖ nh·ªõ cho nh√≥m c·ªßa b·∫°n.</p>
            <input type="text" id="new-group-name-input" placeholder="VD: M√πa H√® Xanh 2025" class="w-full text-center bg-gray-100 border border-gray-300 rounded-md px-3 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="mt-6 flex gap-4">
                <button id="cancel-create-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-6 py-2 rounded-md">H·ªßy</button>
                <button id="confirm-create-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-md">T·∫°o Nh√≥m</button>
            </div>
        </div>
    </div>

    <!-- Join Group Modal -->
    <div id="join-group-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-4">Tham Gia Nh√≥m</h2>
            <p class="text-gray-600 mb-4">Nh·∫≠p m√£ m·ªùi b·∫°n nh·∫≠n ƒë∆∞·ª£c t·ª´ b·∫°n b√®.</p>
            <input type="text" id="group-code-input" placeholder="VD: NHOM-1234" class="w-full text-center uppercase font-mono bg-gray-100 border border-gray-300 rounded-md px-3 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="mt-6 flex gap-4">
                <button id="cancel-join-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-6 py-2 rounded-md">H·ªßy</button>
                <button id="confirm-join-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-md">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <!-- Main Application Screen -->
    <div id="app-screen" class="hidden min-h-screen w-full p-2 md:p-4">
         <div class="flex flex-col md:grid md:grid-cols-3 lg:grid-cols-4 gap-4 md:h-[calc(100vh-2rem)]">

            <!-- Left Panel -->
            <div class="md:col-span-1 lg:col-span-1 bg-white rounded-xl shadow p-4 flex flex-col md:overflow-y-auto">
                <div>
                     <div class="flex items-center justify-between mb-2">
                        <h2 id="group-name-display" class="text-2xl font-bold text-gray-900 truncate"></h2>
                        <button id="rename-group-btn" class="hidden text-gray-500 hover:text-blue-600 p-1" title="ƒê·ªïi t√™n nh√≥m">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded-r-lg mb-4">
                        <p class="text-sm text-blue-800">M√£ m·ªùi: <span id="group-code-display" class="font-mono font-semibold text-blue-900"></span></p>
                         <button id="copy-link-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold mt-1">Sao ch√©p li√™n k·∫øt m·ªùi</button>
                    </div>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
                        <h3 class="font-semibold text-lg mb-2 text-gray-800">Th√¥ng tin c·ªßa b·∫°n</h3>
                        <p class="text-xs text-gray-500 mb-2 break-all">ID: <span id="user-id-display" class="font-mono"></span></p>
                        <div class="space-y-1 text-sm text-gray-700">
                            <p>Tr·∫°ng th√°i: <span id="location-status" class="font-medium text-yellow-600">ƒêang l·∫•y v·ªã tr√≠...</span></p>
                            <p>T·ªëc ƒë·ªô: <span id="speed-display" class="font-mono text-green-600">0</span> km/h</p>
                        </div>
                    </div>

                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
                         <h3 class="font-semibold text-lg mb-2 text-gray-800">T√™n hi·ªÉn th·ªã</h3>
                         <div id="display-name-view" class="flex items-center justify-between">
                            <span id="device-name-display" class="text-gray-900 font-medium"></span>
                            <button id="edit-name-btn" class="text-gray-500 hover:text-blue-600 p-1" title="ƒê·ªïi t√™n">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                         </div>
                         <div id="edit-name-view" class="hidden">
                             <div class="flex gap-2">
                                <input type="text" id="device-name-input" class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button id="save-name-button" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md transition" title="L∆∞u">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button id="cancel-edit-name-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 p-2 rounded-md transition" title="H·ªßy">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                             </div>
                         </div>
                    </div>
                     <button id="leave-group-btn" class="w-full mt-2 bg-red-100 text-red-700 hover:bg-red-200 font-bold py-2 px-4 rounded-lg text-sm transition">R·ªùi Nh√≥m</button>
                </div>

                <div class="flex flex-col min-h-0 mt-4">
                    <h3 class="font-semibold text-lg mb-2 text-gray-800">Th√†nh vi√™n nh√≥m</h3>
                    <div class="mb-3">
                        <input type="search" id="search-user-input" placeholder="T√¨m th√†nh vi√™n..." class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div id="status-filter-buttons" class="mt-2 flex border border-gray-200 rounded-md">
                            <button data-status="all" class="flex-1 text-xs py-1 px-2 bg-blue-500 text-white rounded-l-md">T·∫•t c·∫£</button>
                            <button data-status="online" class="flex-1 text-xs py-1 px-2 border-l border-r border-gray-200">Tr·ª±c tuy·∫øn</button>
                            <button data-status="offline" class="flex-1 text-xs py-1 px-2 rounded-r-md">Ngo·∫°i tuy·∫øn</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 overflow-y-auto min-h-[200px]">
                        <ul id="user-list" class="space-y-3"></ul>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="md:col-span-2 lg:col-span-3 bg-white rounded-xl shadow p-1 md:p-2 h-[65vh] md:h-auto">
                <div id="map-container">
                    <div id="map"></div>
                    <div class="absolute top-2 right-2 z-[999] flex flex-col gap-2">
                         <button id="center-on-me-btn" class="bg-white hover:bg-gray-100 text-gray-800 font-bold w-10 h-10 rounded-full shadow-md flex items-center justify-center" title="V·ªÅ v·ªã tr√≠ c·ªßa t√¥i"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M12 8.25a3.75 3.75 0 1 0 0 7.5 3.75 3.75 0 0 0 0-7.5Z" /><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V12a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V6Z" clip-rule="evenodd" /></svg></button>
                         <button id="fit-all-users-btn" class="bg-white hover:bg-gray-100 text-gray-800 font-bold w-10 h-10 rounded-full shadow-md flex items-center justify-center" title="Xem t·∫•t c·∫£"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M18.375 2.25a.75.75 0 0 0-1.125.41L15.75 6H12.75a.75.75 0 0 0 0 1.5h3.438L15 9.688a.75.75 0 0 0 1.125.41l3.375-3.375a.75.75 0 0 0 0-1.06L19.5 5.625l-1.937-1.938a.75.75 0 0 0-.188-.437ZM19.5 6.438l.938.937-2.25 2.25a.75.75 0 0 0 0 1.06l.938.938-1.5 1.5a.75.75 0 0 0-1.06 0l-3.75 3.75a.75.75 0 0 0 0 1.06l1.5 1.5-.937.937a.75.75 0 0 0-1.06 0l-3.375-3.375a.75.75 0 0 0-1.06 0L4.5 18.375a.75.75 0 0 0 .41 1.125l3.375 1.125a.75.75 0 0 0 .6-.094l1.625-1.083a.75.75 0 0 0 .281-.53v-3.438l1.5-1.5a.75.75 0 0 0 1.06 0l3-3a.75.75 0 0 0 0-1.06l-1.5-1.5.938-.937a.75.75 0 0 0 0-1.06L19.5 6.438Z" /></svg></button>
                         <button id="wake-lock-btn" class="bg-white hover:bg-gray-100 text-gray-800 font-bold w-10 h-10 rounded-full shadow-md flex items-center justify-center hidden" title="Gi·ªØ m√†n h√¨nh lu√¥n s√°ng"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.106a.75.75 0 0 1 0 1.06l-1.591 1.59a.75.75 0 1 1-1.06-1.06l1.59-1.591a.75.75 0 0 1 1.06 0ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5h2.25a.75.75 0 0 1 .75.75ZM17.834 18.894a.75.75 0 0 1-1.06 0l-1.59-1.591a.75.75 0 1 1 1.06-1.06l1.59 1.591a.75.75 0 0 1 0 1.06ZM12 18.75a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0v-2.25a.75.75 0 0 1 .75-.75ZM5.106 17.834a.75.75 0 0 1 0-1.06l1.591-1.59a.75.75 0 1 1 1.06 1.06l-1.591 1.59a.75.75 0 0 1-1.06 0ZM4.5 12a.75.75 0 0 1-.75-.75V9a.75.75 0 0 1 1.5 0v2.25A.75.75 0 0 1 4.5 12ZM6.106 5.106a.75.75 0 0 1 1.06 0l1.591 1.59a.75.75 0 0 1-1.06 1.06l-1.59-1.591a.75.75 0 0 1 0-1.06Z" /></svg></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center"><p id="notification-message" class="text-lg mb-4 text-gray-800"></p><button onclick="document.getElementById('notification-modal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-md">ƒê√£ hi·ªÉu</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, updateDoc, getDoc, addDoc, getDocs, query, where, arrayUnion, arrayRemove, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyD3ZZT39FFnPINSnwXmFTFYLuUUoubHGiA",
             authDomain: "ailocal-86167.firebaseapp.com",
             projectId: "ailocal-86167",
             storageBucket: "ailocal-86167.appspot.com",
             messagingSenderId: "303592611625",
             appId: "1:303592611625:web:ec5967ec4e6f8bbc00e138"
        };

        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const authStatus = document.getElementById('auth-status');
        const createGroupBtn = document.getElementById('create-group-btn');
        const joinGroupBtn = document.getElementById('join-group-btn');
        const createGroupModal = document.getElementById('create-group-modal');
        const newGroupNameInput = document.getElementById('new-group-name-input');
        const cancelCreateBtn = document.getElementById('cancel-create-btn');
        const confirmCreateBtn = document.getElementById('confirm-create-btn');
        const joinGroupModal = document.getElementById('join-group-modal');
        const groupCodeInput = document.getElementById('group-code-input');
        const cancelJoinBtn = document.getElementById('cancel-join-btn');
        const confirmJoinBtn = document.getElementById('confirm-join-btn');
        const mapElement = document.getElementById('map');
        const groupNameDisplay = document.getElementById('group-name-display');
        const renameGroupBtn = document.getElementById('rename-group-btn');
        const groupCodeDisplay = document.getElementById('group-code-display');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const locationStatus = document.getElementById('location-status');
        const speedDisplay = document.getElementById('speed-display');
        const displayNameView = document.getElementById('display-name-view');
        const editNameView = document.getElementById('edit-name-view');
        const deviceNameDisplay = document.getElementById('device-name-display');
        const editNameBtn = document.getElementById('edit-name-btn');
        const deviceNameInput = document.getElementById('device-name-input');
        const saveNameButton = document.getElementById('save-name-button');
        const cancelEditNameBtn = document.getElementById('cancel-edit-name-btn');
        const leaveGroupBtn = document.getElementById('leave-group-btn');
        const searchUserInput = document.getElementById('search-user-input');
        const statusFilterButtons = document.getElementById('status-filter-buttons');
        const userList = document.getElementById('user-list');
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        const centerOnMeBtn = document.getElementById('center-on-me-btn');
        const fitAllUsersBtn = document.getElementById('fit-all-users-btn');
        const wakeLockBtn = document.getElementById('wake-lock-btn');
        
        // --- Global State ---
        let db, auth, currentUser = null, currentGroup = null, map = null, markerClusterGroup = null;
        let mapObjects = {}, groupUnsubscribe = null, locationsUnsubscribe = null, wakeLock = null, lastPosition = null;
        let allUsersData = [];
        const speedReadings = [], SMOOTHING_FACTOR = 5, PATH_ARCHIVE_THRESHOLD = 50, OFFLINE_THRESHOLD_MINUTES = 2;

        // --- Utility Functions ---
        function showNotification(message) { notificationMessage.textContent = message; notificationModal.classList.remove('hidden'); }
        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'kh√¥ng r√µ';
            const now = new Date(); const seconds = Math.floor((now - timestamp.toDate()) / 1000);
            if (seconds < 60) return 'v·ª´a xong'; let interval = seconds / 60;
            if(interval < 60) return `${Math.floor(interval)} ph√∫t tr∆∞·ªõc`; interval /= 60;
            if(interval < 24) return `${Math.floor(interval)} gi·ªù tr∆∞·ªõc`; interval /= 24;
            return `${Math.floor(interval)} ng√†y tr∆∞·ªõc`;
        }
        function setButtonLoadingState(button, isLoading, originalText, loadingText = 'ƒêang x·ª≠ l√Ω...') { button.disabled = isLoading; button.textContent = isLoading ? loadingText : originalText; }
        
        // --- UI Transitions ---
        function showAppScreen() { authScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); }
        function showAuthScreen() { appScreen.classList.add('hidden'); authScreen.classList.remove('hidden'); joinGroupModal.classList.add('hidden'); createGroupModal.classList.add('hidden'); }
        
        // --- Main Application Logic ---
        function initializeAppForGroup() {
            showAppScreen();
            userIdDisplay.textContent = currentUser.uid.substring(0, 8) + '...';
            groupCodeDisplay.textContent = currentGroup.code;
            groupNameDisplay.textContent = currentGroup.name;
            const currentDeviceName = localStorage.getItem('deviceName') || 'Ng∆∞·ªùi d√πng ·∫©n danh';
            deviceNameDisplay.textContent = currentDeviceName;
            deviceNameInput.value = currentDeviceName;
            
            if (currentUser.uid === currentGroup.ownerId) {
                renameGroupBtn.classList.remove('hidden');
                leaveGroupBtn.textContent = 'X√≥a Nh√≥m';
                leaveGroupBtn.classList.remove('bg-red-100', 'text-red-700', 'hover:bg-red-200');
                leaveGroupBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
            } else {
                renameGroupBtn.classList.add('hidden');
                leaveGroupBtn.textContent = 'R·ªùi Nh√≥m';
                leaveGroupBtn.classList.add('bg-red-100', 'text-red-700', 'hover:bg-red-200');
                leaveGroupBtn.classList.remove('bg-red-600', 'text-white', 'hover:bg-red-700');
            }

            if (!map) initializeMap();
            startWatchingLocation();
            startListeningToGroupChanges();
            initializeWakeLock();
        }

        function initializeMap() {
            map = L.map(mapElement, { zoomControl: false }).setView([21.0285, 105.8542], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap', maxZoom: 19 }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            // S·ª¨A L·ªñI: Th√™m t√πy ch·ªçn spiderfyOnEveryClick
            markerClusterGroup = L.markerClusterGroup({
                spiderfyOnEveryClick: true,
                showCoverageOnHover: false,
            });
            map.addLayer(markerClusterGroup);
        }
        
        async function createGroup(groupName) {
            if (!groupName) { showNotification("Vui l√≤ng ƒë·∫∑t t√™n cho nh√≥m."); return; }
            const originalText = confirmCreateBtn.textContent;
            setButtonLoadingState(confirmCreateBtn, true, originalText, 'ƒêang t·∫°o...');
            const groupCode = `NHOM-${Math.floor(1000 + Math.random() * 9000)}`;
            try {
                const newGroupRef = await addDoc(collection(db, "groups"), {
                    name: groupName, ownerId: currentUser.uid, code: groupCode, 
                    members: [currentUser.uid], createdAt: serverTimestamp()
                });
                currentGroup = { id: newGroupRef.id, name: groupName, code: groupCode, ownerId: currentUser.uid };
                localStorage.setItem('groupId', currentGroup.id);
                await ensureUserLocationDocExists();
                initializeAppForGroup();
                createGroupModal.classList.add('hidden');
                newGroupNameInput.value = '';
            } catch (error) { setButtonLoadingState(confirmCreateBtn, false, originalText); }
        }
        
        async function joinGroupLogic(groupCode) {
            if (!groupCode) { showNotification("Vui l√≤ng nh·∫≠p m√£ m·ªùi."); return false; }
            try {
                const q = query(collection(db, "groups"), where("code", "==", groupCode.toUpperCase()));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { showNotification("M√£ nh√≥m kh√¥ng t·ªìn t·∫°i."); return false; }
                const groupDoc = querySnapshot.docs[0];
                const groupData = groupDoc.data();
                currentGroup = { id: groupDoc.id, name: groupData.name, code: groupData.code, ownerId: groupData.ownerId };
                await updateDoc(doc(db, "groups", currentGroup.id), { members: arrayUnion(currentUser.uid) });
                localStorage.setItem('groupId', currentGroup.id);
                await ensureUserLocationDocExists();
                initializeAppForGroup();
                return true;
            } catch (error) { return false; }
        }
        
        async function leaveGroup(wasKicked = false) {
            if (!currentGroup) return;
            if (!wasKicked) { try { await updateDoc(doc(db, "groups", currentGroup.id), { members: arrayRemove(currentUser.uid) }); } catch(error) { console.error(error); } }
            if (groupUnsubscribe) { groupUnsubscribe(); groupUnsubscribe = null; }
            if (locationsUnsubscribe) { locationsUnsubscribe(); locationsUnsubscribe = null; }
            localStorage.removeItem('groupId'); currentGroup = null;
            markerClusterGroup.clearLayers(); mapObjects = {};
            showAuthScreen();
            if (wasKicked) showNotification("B·∫°n ƒë√£ b·ªã x√≥a kh·ªèi nh√≥m.");
        }
        
        async function deleteGroup() {
            if(!currentGroup || currentUser.uid !== currentGroup.ownerId) return;
            if(confirm("H√ÄNH ƒê·ªòNG KH√îNG TH·ªÇ HO√ÄN T√ÅC!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn nh√≥m n√†y cho t·∫•t c·∫£ m·ªçi ng∆∞·ªùi kh√¥ng?")) {
                try {
                    await deleteDoc(doc(db, "groups", currentGroup.id));
                    leaveGroup(true); 
                    showNotification("ƒê√£ x√≥a nh√≥m th√†nh c√¥ng.");
                } catch(error) { console.error("L·ªói khi x√≥a nh√≥m:", error); }
            }
        }

        window.removeUserFromGroup = async (userIdToRemove, userName) => {
            if (!currentGroup || currentUser.uid !== currentGroup.ownerId) return;
            if(confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a "${userName}" kh·ªèi nh√≥m kh√¥ng?`)) {
                try {
                    await updateDoc(doc(db, "groups", currentGroup.id), { members: arrayRemove(userIdToRemove) });
                    await deleteDoc(doc(db, `groups/${currentGroup.id}/locations`, userIdToRemove));
                    showNotification(`ƒê√£ x√≥a "${userName}" kh·ªèi nh√≥m.`);
                } catch (error) { console.error(error); }
            }
        }

        async function renameGroup() {
            if (!currentGroup || currentUser.uid !== currentGroup.ownerId) return;
            const newName = prompt("Nh·∫≠p t√™n nh√≥m m·ªõi:", currentGroup.name);
            if (newName && newName.trim() !== '') {
                try { await updateDoc(doc(db, "groups", currentGroup.id), { name: newName.trim() }); showNotification("ƒê√£ ƒë·ªïi t√™n nh√≥m th√†nh c√¥ng."); } 
                catch (error) { console.error(error); }
            }
        }

        async function ensureUserLocationDocExists() {
            const locationDocRef = doc(db, `groups/${currentGroup.id}/locations`, currentUser.uid);
            const docSnap = await getDoc(locationDocRef);
            if (!docSnap.exists()) await setDoc(locationDocRef, { name: localStorage.getItem('deviceName') || 'Ng∆∞·ªùi d√πng ·∫©n danh', timestamp: serverTimestamp(), path: [] });
        }
        
        const requestWakeLock = async () => {
            try { wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', () => { updateWakeLockButtonUI(false); wakeLock = null; }); updateWakeLockButtonUI(true); } 
            catch (err) { console.error(err); }
        };
        const releaseWakeLock = async () => { if (!wakeLock) return; await wakeLock.release(); wakeLock = null; updateWakeLockButtonUI(false); };
        function updateWakeLockButtonUI(isLocked) {
             if (isLocked) wakeLockBtn.classList.add('text-yellow-500', 'bg-gray-200'); else wakeLockBtn.classList.remove('text-yellow-500', 'bg-gray-200');
        }
        function initializeWakeLock() {
            if ('wakeLock' in navigator) {
                wakeLockBtn.classList.remove('hidden');
                wakeLockBtn.addEventListener('click', () => {
                    const isLocking = !wakeLock;
                    localStorage.setItem('wakeLockEnabled', String(isLocking));
                    if(isLocking) requestWakeLock(); else releaseWakeLock();
                });
                document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible' && localStorage.getItem('wakeLockEnabled') === 'true') requestWakeLock(); });
            }
        }
        
        function startListeningToGroupChanges() {
            if (groupUnsubscribe) groupUnsubscribe();
            groupUnsubscribe = onSnapshot(doc(db, "groups", currentGroup.id), (groupDoc) => {
                if (!groupDoc.exists()) { leaveGroup(true); return; }
                const groupData = groupDoc.data();
                if (!groupData.members.includes(currentUser.uid)) { leaveGroup(true); return; }
                currentGroup.ownerId = groupData.ownerId;
                currentGroup.name = groupData.name;
                groupNameDisplay.textContent = currentGroup.name;
                startListeningToLocations();
            });
        }

        function startListeningToLocations() {
            if (locationsUnsubscribe) return;
            locationsUnsubscribe = onSnapshot(collection(db, `groups/${currentGroup.id}/locations`), (snapshot) => {
                const activeUserIds = new Set(snapshot.docs.map(d => d.id));
                allUsersData = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                allUsersData.forEach(user => updateUserOnMap(user.id, user));
                Object.keys(mapObjects).forEach(userId => { if (!activeUserIds.has(userId)) removeUserFromMap(userId); });
                updateUserListUI(allUsersData);
            });
        }
        
        function updateUserOnMap(userId, userData) {
            if (!map || !userData.path || userData.path.length === 0) return;
            const path = userData.path, lastPoint = path[path.length - 1], latLng = [lastPoint.lat, lastPoint.lng];
            const isCurrentUser = userId === currentUser.uid;
            if (!mapObjects[userId]) mapObjects[userId] = { marker: null, polyline: null };
            const userMapObject = mapObjects[userId];
            const markerIcon = L.divIcon({ className: isCurrentUser ? 'current-user-marker' : 'other-user-marker', html: isCurrentUser ? '' : `<span>${(userData.name || 'A').charAt(0).toUpperCase()}</span>`, iconSize: isCurrentUser ? [28, 28] : [24, 24], iconAnchor: isCurrentUser ? [14, 14] : [12, 12] });
            
            if (userMapObject.marker) {
                userMapObject.marker.setLatLng(latLng).setIcon(markerIcon);
                userMapObject.marker.options.userData = userData;
            } else { 
                userMapObject.marker = L.marker(latLng, { icon: markerIcon, userData: userData }); 
                markerClusterGroup.addLayer(userMapObject.marker); 
            }
            
            userMapObject.marker.bindPopup(`<div class="font-sans"><strong class="text-base">${userData.name || 'Ng∆∞·ªùi d√πng ·∫©n danh'}</strong><br>T·ªëc ƒë·ªô: ${userData.lastSpeed?.toFixed(1) || 0} km/h ${isCurrentUser ? '<br><em class="text-gray-500">(B·∫°n)</em>' : ''}</div>`);
            
            const isOnline = userData.timestamp ? (Date.now() - userData.timestamp.toDate().getTime()) < OFFLINE_THRESHOLD_MINUTES * 60 * 1000 : false;
            const polylineOptions = { color: isOnline ? (isCurrentUser ? '#22c55e' : '#3b82f6') : '#9ca3af', weight: 4, opacity: isOnline ? 0.8 : 0.6, dashArray: isOnline ? null : '5, 10' };
            if (userMapObject.polyline) {
                 userMapObject.polyline.setLatLngs(path.map(p => [p.lat, p.lng])).setStyle(polylineOptions);
            } else {
                 userMapObject.polyline = L.polyline(path.map(p => [p.lat, p.lng]), polylineOptions).addTo(map);
            }
        }
        
        function removeUserFromMap(userId) {
            if (mapObjects[userId]) {
                if (mapObjects[userId].marker) markerClusterGroup.removeLayer(mapObjects[userId].marker);
                if (mapObjects[userId].polyline) map.removeLayer(mapObjects[userId].polyline);
                delete mapObjects[userId];
            }
        }
        
        function updateUserListUI(users) {
            userList.innerHTML = '';
            const isOwner = currentUser.uid === currentGroup.ownerId;
            const searchTerm = searchUserInput.value.toLowerCase();
            const activeFilter = statusFilterButtons.querySelector('.bg-blue-500').dataset.status;

            users.sort((a,b) => (a.name || '').localeCompare(b.name || '')).forEach(user => {
                const isCurrentUser = user.id === currentUser.uid;
                const isOnline = user.timestamp ? (Date.now() - user.timestamp.toDate().getTime()) < OFFLINE_THRESHOLD_MINUTES * 60 * 1000 : false;
                const matchesSearch = (user.name || 'Ng∆∞·ªùi d√πng ·∫©n danh').toLowerCase().includes(searchTerm);
                const matchesStatus = (activeFilter === 'all') || (activeFilter === 'online' && isOnline) || (activeFilter === 'offline' && !isOnline);
                if (!matchesSearch || !matchesStatus) return;

                const li = document.createElement('li');
                li.className = `p-2 rounded-md transition ${isCurrentUser ? 'bg-blue-50' : 'hover:bg-gray-100'}`;
                const statusText = `Ho·∫°t ƒë·ªông ${formatTimeAgo(user.timestamp)}`;
                const ownerIcon = user.id === currentGroup.ownerId ? 'üëë' : '';
                let removeButton = '';
                if(isOwner && !isCurrentUser) {
                    removeButton = `<button onclick="window.removeUserFromGroup('${user.id}', '${user.name || 'Ng∆∞·ªùi d√πng ·∫©n danh'}')" class="text-red-500 hover:text-red-700 p-1" title="X√≥a th√†nh vi√™n"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>`;
                }
                const statusDotColor = isOnline ? 'bg-green-500' : 'bg-gray-400';
                li.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-grow cursor-pointer" onclick="window.panToUser('${user.id}')">
                           <div class="relative">
                               <div class="w-10 h-10 rounded-full ${isCurrentUser ? 'bg-green-500' : 'bg-blue-500'} flex items-center justify-center font-bold text-white">${(user.name || 'A').charAt(0).toUpperCase()}</div>
                               <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full ${statusDotColor} border-2 border-white"></span>
                           </div>
                            <div><p class="font-semibold text-gray-800">${user.name || 'Ng∆∞·ªùi d√πng ·∫©n danh'} <span class="text-yellow-500">${ownerIcon}</span></p><p class="text-xs text-gray-500">${statusText}</p></div>
                        </div>
                        ${removeButton}
                    </div>
                    <div class="mt-2 text-right"><button id="load-history-${user.id}" onclick="window.loadAndDisplayFullPath('${user.id}')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-2 py-1 rounded-md transition">Xem ƒë·∫ßy ƒë·ªß</button></div>`;
                userList.appendChild(li);
            });
        }
        
        window.loadAndDisplayFullPath = async (userId) => {
            const button = document.getElementById(`load-history-${userId}`);
            const originalText = button.textContent;
            setButtonLoadingState(button, true, originalText, 'ƒêang t·∫£i...');
            try {
                const archiveQuery = query(collection(db, `groups/${currentGroup.id}/locations/${userId}/path_archives`), orderBy("createdAt", "asc"));
                const [userDocSnap, archiveSnap] = await Promise.all([getDoc(doc(db, `groups/${currentGroup.id}/locations`, userId)), getDocs(archiveQuery)]);
                if (!userDocSnap.exists()) { showNotification("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng."); return; }
                const userData = userDocSnap.data();
                const fullPath = [...archiveSnap.docs.flatMap(d => d.data().segment || []), ...(userData.path || [])];
                updateUserOnMap(userId, { ...userData, path: fullPath });
                button.textContent = 'ƒê√£ t·∫£i';
                button.disabled = true;
            } catch (error) { console.error(`L·ªói t·∫£i l·ªãch s·ª≠:`, error); setButtonLoadingState(button, false, originalText); }
        };

        window.panToUser = (userId) => { if (mapObjects[userId]?.marker) markerClusterGroup.zoomToShowLayer(mapObjects[userId].marker, () => mapObjects[userId].marker.openPopup()); };
        
        function calculateAndSmoothSpeed(newPosition) {
            if (!lastPosition) { lastPosition = newPosition; return 0; }
            const distanceMeters = L.latLng(lastPosition.coords.latitude, lastPosition.coords.longitude).distanceTo(L.latLng(newPosition.coords.latitude, newPosition.coords.longitude));
            const timeSeconds = (newPosition.timestamp - lastPosition.timestamp) / 1000;
            if (timeSeconds <= 0) { lastPosition = newPosition; return speedReadings.length > 0 ? speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length : 0; }
            const speedKmh = (distanceMeters / timeSeconds) * 3.6;
            speedReadings.push(speedKmh); if (speedReadings.length > SMOOTHING_FACTOR) speedReadings.shift();
            lastPosition = newPosition; return speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length;
        }

        async function updateLocationInFirestore({ latitude, longitude, speedKmh }) {
            if (!db || !currentUser || !currentGroup) return;
            const locationDocRef = doc(db, `groups/${currentGroup.id}/locations`, currentUser.uid);
            try {
                const docSnap = await getDoc(locationDocRef);
                if (!docSnap.exists()) return;
                const userData = docSnap.data();
                const currentPath = userData.path || [];
                const newPoint = { lat: latitude, lng: longitude };

                if (currentPath.length >= PATH_ARCHIVE_THRESHOLD) {
                    const newPath = [currentPath[currentPath.length - 1], newPoint];
                    await addDoc(collection(db, `groups/${currentGroup.id}/locations/${currentUser.uid}/path_archives`), { segment: currentPath, createdAt: serverTimestamp() });
                    await updateDoc(locationDocRef, { timestamp: serverTimestamp(), lastSpeed: speedKmh, path: newPath });
                } else {
                    await updateDoc(locationDocRef, { timestamp: serverTimestamp(), lastSpeed: speedKmh, path: arrayUnion(newPoint) });
                }
            } catch (error) { console.error("L·ªói c·∫≠p nh·∫≠t v·ªã tr√≠:", error); }
        }
        
        function startWatchingLocation() {
            if (!navigator.geolocation) { locationStatus.textContent = 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£'; return; }
            navigator.geolocation.watchPosition( (position) => {
                locationStatus.textContent = 'ƒêang ho·∫°t ƒë·ªông';
                const { latitude, longitude } = position.coords;
                const speedKmh = calculateAndSmoothSpeed(position);
                speedDisplay.textContent = speedKmh.toFixed(1);
                updateLocationInFirestore({ latitude, longitude, speedKmh });
            }, (error) => { locationStatus.textContent = 'L·ªói v·ªã tr√≠.'; }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } );
        }

        // --- Event Listeners ---
        createGroupBtn.addEventListener('click', () => createGroupModal.classList.remove('hidden'));
        cancelCreateBtn.addEventListener('click', () => createGroupModal.classList.add('hidden'));
        confirmCreateBtn.addEventListener('click', () => createGroup(newGroupNameInput.value));
        joinGroupBtn.addEventListener('click', () => joinGroupModal.classList.remove('hidden'));
        cancelJoinBtn.addEventListener('click', () => joinGroupModal.classList.add('hidden'));
        confirmJoinBtn.addEventListener('click', async () => {
            const code = groupCodeInput.value; if (!code) { showNotification("Vui l√≤ng nh·∫≠p m√£ m·ªùi."); return; }
            const originalText = confirmJoinBtn.textContent;
            setButtonLoadingState(confirmJoinBtn, true, originalText, 'ƒêang ki·ªÉm tra...');
            const success = await joinGroupLogic(code);
            if (!success) setButtonLoadingState(confirmJoinBtn, false, originalText);
        });
        leaveGroupBtn.addEventListener('click', () => { 
            if (currentUser.uid === currentGroup.ownerId) {
                deleteGroup();
            } else {
                if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën r·ªùi nh√≥m?")) leaveGroup(); 
            }
        });
        renameGroupBtn.addEventListener('click', renameGroup);
        editNameBtn.addEventListener('click', () => { displayNameView.classList.add('hidden'); editNameView.classList.remove('hidden'); });
        cancelEditNameBtn.addEventListener('click', () => { deviceNameInput.value = deviceNameDisplay.textContent; editNameView.classList.add('hidden'); displayNameView.classList.remove('hidden'); });
        saveNameButton.addEventListener('click', async () => {
            const newName = deviceNameInput.value.trim();
            if (newName && currentUser && currentGroup) {
                localStorage.setItem('deviceName', newName);
                await updateDoc(doc(db, `groups/${currentGroup.id}/locations`, currentUser.uid), { name: newName });
                deviceNameDisplay.textContent = newName;
                editNameView.classList.add('hidden');
                displayNameView.classList.remove('hidden');
                showNotification(`T√™n ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh "${newName}".`);
            }
        });
        copyLinkBtn.addEventListener('click', () => {
            const baseUrl = window.location.href.split('?')[0];
            const shareLink = `${baseUrl}?group_code=${currentGroup.code}`;
            navigator.clipboard.writeText(shareLink).then(() => showNotification(`ƒê√£ sao ch√©p li√™n k·∫øt m·ªùi!`));
        });
        centerOnMeBtn.addEventListener('click', () => { if(currentUser?.uid && mapObjects[currentUser.uid]?.marker) map.setView(mapObjects[currentUser.uid].marker.getLatLng(), 16) });
        fitAllUsersBtn.addEventListener('click', () => { if (markerClusterGroup.getBounds().isValid()) map.fitBounds(markerClusterGroup.getBounds().pad(0.1)); });
        searchUserInput.addEventListener('input', () => updateUserListUI(allUsersData));
        statusFilterButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                statusFilterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-blue-500', 'text-white'));
                e.target.classList.add('bg-blue-500', 'text-white');
                updateUserListUI(allUsersData);
            }
        });

        // --- Initialization ---
        function main() {
            try {
                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        const urlParams = new URLSearchParams(window.location.search);
                        const groupCodeFromUrl = urlParams.get('group_code');
                        if (groupCodeFromUrl) {
                            authStatus.textContent = `ƒêang tham gia nh√≥m t·ª´ li√™n k·∫øt...`;
                            window.history.replaceState({}, document.title, window.location.pathname);
                            await joinGroupLogic(groupCodeFromUrl);
                        } else {
                            const storedGroupId = localStorage.getItem('groupId');
                            if (storedGroupId) {
                                authStatus.textContent = 'ƒêang k·∫øt n·ªëi l·∫°i nh√≥m...';
                                const groupDoc = await getDoc(doc(db, "groups", storedGroupId));
                                if (groupDoc.exists()) {
                                    const groupData = groupDoc.data();
                                    currentGroup = { id: storedGroupId, name: groupData.name, code: groupData.code, ownerId: groupData.ownerId };
                                    initializeAppForGroup();
                                } else { 
                                    localStorage.removeItem('groupId');
                                    authStatus.textContent = 'ƒê√£ k·∫øt n·ªëi. S·∫µn s√†ng!';
                                }
                            } else {
                                authStatus.textContent = 'ƒê√£ k·∫øt n·ªëi. S·∫µn s√†ng!';
                            }
                        }
                        createGroupBtn.disabled = false;
                        joinGroupBtn.disabled = false;
                    } else { signInAnonymously(auth).catch((err) => { console.error(err); authStatus.textContent = 'L·ªói x√°c th·ª±c.'; }); }
                });
            } catch (error) { console.error(error); authStatus.textContent = 'L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng.'; }
        }
        
        main();
    </script>
</body>
</html>
