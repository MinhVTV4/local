<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo Dõi Vị Trí Thời Gian Thực - V3.2 (Điều Khiển Bản Đồ)</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to complement Tailwind */
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
        }
        /* Custom icon for other users */
        .other-user-marker {
            background-color: #3b82f6; /* bg-blue-500 */
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }
        /* Custom icon for the current user */
        .current-user-marker {
            background-color: #22c55e; /* bg-green-500 */
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 9999px;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        /* Container for the map to position controls */
        #map-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
        }
        /* Ensure Leaflet controls are on top */
        .leaflet-pane { z-index: 1; }
        .leaflet-top, .leaflet-bottom { z-index: 2; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Authentication Screen: Shown on page load -->
    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center p-4 text-center bg-white">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Chào mừng bạn!</h1>
        <p class="text-lg text-gray-600 mb-8 max-w-2xl">
            Đây là một ứng dụng theo dõi vị trí thời gian thực. Nhấn nút bên dưới để bắt đầu ghi lại và chia sẻ hành trình của bạn.
        </p>
        <button id="start-tracking-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg">
            Bắt đầu Ghi Hành Trình
        </button>
        <p id="auth-status" class="mt-4 text-gray-500 text-sm">Đang chờ xác thực...</p>
    </div>

    <!-- Main Application Screen: Hidden until authenticated -->
    <div id="app-screen" class="hidden min-h-screen w-full p-2 md:p-4">
        <div class="flex flex-col md:grid md:grid-cols-3 lg:grid-cols-4 gap-4 md:h-[calc(100vh-2rem)]">

            <!-- Left Panel: Controls & Info -->
            <div class="md:col-span-1 lg:col-span-1 bg-white rounded-xl shadow p-4 flex flex-col md:overflow-y-auto">
                <div>
                    <h2 class="text-2xl font-bold mb-1 text-gray-900">Bảng điều khiển</h2>
                    <p class="text-xs text-gray-500 mb-4 break-all">ID Phiên: <span id="app-id-display" class="font-mono"></span></p>
                    <p class="text-xs text-gray-500 mb-4 break-all">ID của bạn: <span id="user-id-display" class="font-mono"></span></p>

                    <!-- Your Info -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
                        <h3 class="font-semibold text-lg mb-2 text-gray-800">Thông tin của bạn</h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <p>Trạng thái: <span id="location-status" class="font-medium text-yellow-600">Đang lấy vị trí...</span></p>
                            <p>Vĩ độ: <span id="lat-display" class="font-mono text-green-600">N/A</span></p>
                            <p>Kinh độ: <span id="lng-display" class="font-mono text-green-600">N/A</span></p>
                            <p>Tốc độ: <span id="speed-display" class="font-mono text-green-600">0</span> km/h</p>
                        </div>
                    </div>

                    <!-- Set Device Name -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
                         <h3 class="font-semibold text-lg mb-2 text-gray-800">Tên hiển thị</h3>
                         <div class="flex gap-2">
                            <input type="text" id="device-name-input" placeholder="Nhập tên của bạn..." class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="save-name-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 rounded-md text-sm transition">Lưu</button>
                         </div>
                    </div>
                </div>

                <!-- Active Users List -->
                <div class="flex flex-col min-h-0">
                    <h3 class="font-semibold text-lg mb-2 text-gray-800">Người dùng đang hoạt động</h3>
                    <div id="user-list-container" class="bg-gray-50 border border-gray-200 rounded-lg p-3 overflow-y-auto min-h-[250px]">
                        <ul id="user-list" class="space-y-3">
                           <!-- JS will populate this list -->
                           <li class="text-gray-500 text-sm">Đang chờ người dùng khác...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Map -->
            <div class="md:col-span-2 lg:col-span-3 bg-white rounded-xl shadow p-1 md:p-2 h-[65vh] md:h-auto">
                <div id="map-container">
                    <div id="map"></div>
                    <!-- Map control buttons -->
                    <div class="absolute top-2 right-2 z-[999] flex flex-col gap-2">
                        <button id="center-on-me-btn" class="bg-white hover:bg-gray-100 text-gray-800 font-bold w-10 h-10 rounded-full shadow-md flex items-center justify-center" title="Về vị trí của tôi">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                              <path d="M12 8.25a3.75 3.75 0 1 0 0 7.5 3.75 3.75 0 0 0 0-7.5Z" />
                              <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V12a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V6Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button id="fit-all-users-btn" class="bg-white hover:bg-gray-100 text-gray-800 font-bold w-10 h-10 rounded-full shadow-md flex items-center justify-center" title="Xem tất cả">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                             <path d="M18.375 2.25a.75.75 0 0 0-1.125.41L15.75 6H12.75a.75.75 0 0 0 0 1.5h3.438L15 9.688a.75.75 0 0 0 1.125.41l3.375-3.375a.75.75 0 0 0 0-1.06L19.5 5.625l-1.937-1.938a.75.75 0 0 0-.188-.437ZM19.5 6.438l.938.937-2.25 2.25a.75.75 0 0 0 0 1.06l.938.938-1.5 1.5a.75.75 0 0 0-1.06 0l-3.75 3.75a.75.75 0 0 0 0 1.06l1.5 1.5-.937.937a.75.75 0 0 0-1.06 0l-3.375-3.375a.75.75 0 0 0-1.06 0L4.5 18.375a.75.75 0 0 0 .41 1.125l3.375 1.125a.75.75 0 0 0 .6-.094l1.625-1.083a.75.75 0 0 0 .281-.53v-3.438l1.5-1.5a.75.75 0 0 0 1.06 0l3-3a.75.75 0 0 0 0-1.06l-1.5-1.5.938-.937a.75.75 0 0 0 0-1.06L19.5 6.438Z" />
                           </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for notifications -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="notification-message" class="text-lg mb-4 text-gray-800"></p>
            <button onclick="document.getElementById('notification-modal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-md">Đã hiểu</button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Firebase JS SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, updateDoc, arrayUnion, getDoc, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'live-location-tracker-v3-2';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // This is a public test key, replace with your own if deploying
            apiKey: "AIzaSyD3ZZT39FFnPINSnwXmFTFYLuUUoubHGiA",
            authDomain: "ailocal-86167.firebaseapp.com",
            projectId: "ailocal-86167",
            storageBucket: "ailocal-86167.appspot.com",
            messagingSenderId: "303592611625",
            appId: "1:303592611625:web:ec5967ec4e6f8bbc00e138"
        };

        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const startTrackingButton = document.getElementById('start-tracking-button');
        const authStatus = document.getElementById('auth-status');
        const mapElement = document.getElementById('map');
        const appIdDisplay = document.getElementById('app-id-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const locationStatus = document.getElementById('location-status');
        const latDisplay = document.getElementById('lat-display');
        const lngDisplay = document.getElementById('lng-display');
        const speedDisplay = document.getElementById('speed-display');
        const deviceNameInput = document.getElementById('device-name-input');
        const saveNameButton = document.getElementById('save-name-button');
        const userList = document.getElementById('user-list');
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        const centerOnMeBtn = document.getElementById('center-on-me-btn');
        const fitAllUsersBtn = document.getElementById('fit-all-users-btn');
        
        // --- Global State ---
        let db, auth;
        let currentUser = null;
        let map = null;
        let mapObjects = {}; // { userId: { marker, polyline } }
        const FIRESTORE_COLLECTION = `artifacts/${appId}/public/data/locations`;
        let lastPosition = null;
        const speedReadings = [];
        const SMOOTHING_FACTOR = 5; 
        const PATH_ARCHIVE_THRESHOLD = 50;
        const OFFLINE_THRESHOLD_MINUTES = 2;

        // --- Utility Functions ---
        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'không rõ';
            const now = new Date();
            const seconds = Math.floor((now - timestamp.toDate()) / 1000);

            if (seconds < 60) return 'vừa xong';
            let interval = seconds / 60;
            if(interval < 60) return `${Math.floor(interval)} phút trước`;
            interval = interval / 60;
            if(interval < 24) return `${Math.floor(interval)} giờ trước`;
            interval = interval / 24;
            return `${Math.floor(interval)} ngày trước`;
        }

        // --- Core Application Logic ---

        function initializeAppLogic() {
            appIdDisplay.textContent = appId;
            userIdDisplay.textContent = currentUser.uid;
            deviceNameInput.value = localStorage.getItem('deviceName') || '';
            
            authScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');

            initializeMap();
            startWatchingLocation();
            startListeningToOtherUsers();
        }

        function initializeMap() {
            if (map) return;
            // Initialize map view to Hanoi, Vietnam
            map = L.map(mapElement, { zoomControl: false }).setView([21.0285, 105.8542], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
        }

        function centerOnCurrentUser() {
            if (!currentUser || !mapObjects[currentUser.uid] || !mapObjects[currentUser.uid].marker) {
                showNotification("Chưa có vị trí của bạn để hiển thị.");
                return;
            }
            const userMarker = mapObjects[currentUser.uid].marker;
            map.setView(userMarker.getLatLng(), 16); // Zoom to level 16
        }
        
        function fitAllUsers() {
            const markers = Object.values(mapObjects)
                .map(obj => obj.marker)
                .filter(marker => marker != null);

            if (markers.length === 0) {
                 showNotification("Không có người dùng nào để hiển thị trên bản đồ.");
                 return;
            }
            
            if (markers.length === 1) {
                map.setView(markers[0].getLatLng(), 15);
                return;
            }

            const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
            map.fitBounds(bounds.pad(0.2)); // Add 20% padding
        }

        function calculateAndSmoothSpeed(newPosition) {
            if (!lastPosition) {
                lastPosition = newPosition;
                return 0;
            }
            const distanceMeters = L.latLng(lastPosition.coords.latitude, lastPosition.coords.longitude)
                .distanceTo(L.latLng(newPosition.coords.latitude, newPosition.coords.longitude));
            const timeSeconds = (newPosition.timestamp - lastPosition.timestamp) / 1000;
            if (timeSeconds <= 0) {
                 lastPosition = newPosition;
                 return speedReadings.length > 0 ? speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length : 0;
            }
            const speedKmh = (distanceMeters / timeSeconds) * 3.6;
            speedReadings.push(speedKmh);
            if (speedReadings.length > SMOOTHING_FACTOR) speedReadings.shift();
            const smoothedSpeed = speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length;
            lastPosition = newPosition; 
            return smoothedSpeed;
        }

        function startWatchingLocation() {
            if (!navigator.geolocation) {
                locationStatus.textContent = 'Trình duyệt không hỗ trợ';
                showNotification('Trình duyệt của bạn không hỗ trợ Geolocation.');
                return;
            }

            navigator.geolocation.watchPosition(
                (position) => {
                    locationStatus.textContent = 'Đang hoạt động';
                    const { latitude, longitude } = position.coords;
                    const calculatedSpeedKmh = calculateAndSmoothSpeed(position);
                    latDisplay.textContent = latitude.toFixed(5);
                    lngDisplay.textContent = longitude.toFixed(5);
                    speedDisplay.textContent = calculatedSpeedKmh.toFixed(1);
                    updateLocationInFirestore({ latitude, longitude, speedKmh: calculatedSpeedKmh });
                },
                (error) => {
                    let message = 'Lỗi không xác định';
                    if (error.code === error.PERMISSION_DENIED) message = 'Bạn đã từ chối quyền vị trí.';
                    else if (error.code === error.POSITION_UNAVAILABLE) message = 'Vị trí không khả dụng.';
                    locationStatus.textContent = message;
                    showNotification(message);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        async function updateLocationInFirestore({ latitude, longitude, speedKmh }) {
            if (!db || !currentUser) return;

            const userDocRef = doc(db, FIRESTORE_COLLECTION, currentUser.uid);
            const newPoint = { lat: latitude, lng: longitude };

            try {
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) return;
                
                const userData = docSnap.data();
                const currentPath = userData.path || [];

                if (currentPath.length >= PATH_ARCHIVE_THRESHOLD) {
                    console.log(`Đạt ngưỡng ${PATH_ARCHIVE_THRESHOLD} điểm. Đang lưu trữ...`);
                    const newPath = [currentPath[currentPath.length - 1], newPoint];
                    const archiveCollectionRef = collection(db, FIRESTORE_COLLECTION, currentUser.uid, 'path_archives');
                    await addDoc(archiveCollectionRef, {
                        segment: currentPath,
                        createdAt: serverTimestamp()
                    });
                    await updateDoc(userDocRef, {
                        name: deviceNameInput.value.trim() || 'Người dùng ẩn danh',
                        timestamp: serverTimestamp(),
                        lastSpeed: speedKmh,
                        path: newPath
                    });
                } else {
                    await updateDoc(userDocRef, {
                        name: deviceNameInput.value.trim() || 'Người dùng ẩn danh',
                        timestamp: serverTimestamp(),
                        lastSpeed: speedKmh,
                        path: arrayUnion(newPoint)
                    });
                }
            } catch (error) {
                console.error("Lỗi khi cập nhật vị trí:", error);
            }
        }
        
        function startListeningToOtherUsers() {
            const usersCollection = collection(db, FIRESTORE_COLLECTION);
            onSnapshot(usersCollection, (snapshot) => {
                const activeUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const activeUserIds = new Set(activeUsers.map(u => u.id));
                activeUsers.forEach(user => updateUserOnMap(user.id, user));
                Object.keys(mapObjects).forEach(userId => {
                    if (!activeUserIds.has(userId)) removeUserFromMap(userId);
                });
                updateUserListUI(activeUsers);
            }, (error) => {
                console.error("Lỗi Firestore snapshot:", error);
                showNotification(`Lỗi đồng bộ dữ liệu: ${error.message}.`);
            });
        }
        
        function updateUserOnMap(userId, userData) {
            if (!map || !userData.path || userData.path.length === 0) return;

            const path = userData.path;
            const lastPoint = path[path.length - 1];
            const latLng = [lastPoint.lat, lastPoint.lng];
            const isCurrentUser = userId === currentUser.uid;
            
            const now = Date.now();
            const isOnline = userData.timestamp ? (now - userData.timestamp.toDate().getTime()) < OFFLINE_THRESHOLD_MINUTES * 60 * 1000 : false;
            
            if (!mapObjects[userId]) mapObjects[userId] = { marker: null, polyline: null };
            
            const userMapObject = mapObjects[userId];
            const markerIcon = L.divIcon({
                className: isCurrentUser ? 'current-user-marker' : 'other-user-marker',
                html: isCurrentUser ? '' : `<span>${(userData.name || 'A').charAt(0).toUpperCase()}</span>`,
                iconSize: isCurrentUser ? [28, 28] : [24, 24],
                iconAnchor: isCurrentUser ? [14, 14] : [12, 12],
            });

            if (userMapObject.marker) {
                userMapObject.marker.setLatLng(latLng).setIcon(markerIcon);
            } else {
                userMapObject.marker = L.marker(latLng, { icon: markerIcon }).addTo(map);
                if (isCurrentUser && path.length <= 2) map.setView(latLng, 15);
            }
            
            const popupContent = `<div class="font-sans"><strong class="text-base">${userData.name || 'Người dùng ẩn danh'}</strong><br>Tốc độ: ${userData.lastSpeed?.toFixed(1) || 0} km/h ${isCurrentUser ? '<br><em class="text-gray-500">(Đây là bạn)</em>' : ''}</div>`;
            userMapObject.marker.bindPopup(popupContent);

            const polylinePoints = path.map(p => [p.lat, p.lng]);
            const onlineColor = isCurrentUser ? '#22c55e' : '#3b82f6';
            const offlineColor = '#9ca3af';
            const polylineOptions = { 
                color: isOnline ? onlineColor : offlineColor,
                weight: 4,
                opacity: isOnline ? 0.8 : 0.6,
                dashArray: isOnline ? null : '5, 10'
            };
            
            if (userMapObject.polyline) {
                userMapObject.polyline.setLatLngs(polylinePoints).setStyle(polylineOptions);
            } else {
                userMapObject.polyline = L.polyline(polylinePoints, polylineOptions).addTo(map);
            }
        }
        
        function removeUserFromMap(userId) {
            if (mapObjects[userId]) {
                const { marker, polyline } = mapObjects[userId];
                if (marker) map.removeLayer(marker);
                if (polyline) map.removeLayer(polyline);
                delete mapObjects[userId];
            }
        }
        
        function updateUserListUI(users) {
            userList.innerHTML = '';
            const now = Date.now();
            const sortedUsers = users.sort((a, b) => {
                if (a.id === currentUser.uid) return -1;
                if (b.id === currentUser.uid) return 1;
                const aIsOnline = a.timestamp ? (now - a.timestamp.toDate().getTime()) < OFFLINE_THRESHOLD_MINUTES * 60 * 1000 : false;
                const bIsOnline = b.timestamp ? (now - b.timestamp.toDate().getTime()) < OFFLINE_THRESHOLD_MINUTES * 60 * 1000 : false;
                if (aIsOnline && !bIsOnline) return -1;
                if (!aIsOnline && bIsOnline) return 1;
                return (a.name || '').localeCompare(b.name || '');
            });
            
            if (sortedUsers.length === 0 || (sortedUsers.length === 1 && sortedUsers[0].id === currentUser.uid)) {
                userList.innerHTML = '<li class="text-gray-500 text-sm">Chưa có người dùng nào khác.</li>';
                return;
            }

            sortedUsers.forEach(user => {
                const isCurrentUser = user.id === currentUser.uid;
                const isOnline = user.timestamp ? (now - user.timestamp.toDate().getTime()) < OFFLINE_THRESHOLD_MINUTES * 60 * 1000 : false;

                const li = document.createElement('li');
                li.className = `p-2 rounded-md transition ${isCurrentUser ? 'bg-blue-50' : 'hover:bg-gray-100'} ${!isOnline && !isCurrentUser ? 'opacity-60' : ''}`;
                
                const statusDotColor = isOnline ? 'bg-green-500' : 'bg-gray-400';
                const statusText = isOnline ? `Tốc độ: ${user.lastSpeed?.toFixed(1) || 0} km/h` : `Hoạt động ${formatTimeAgo(user.timestamp)}`;

                li.innerHTML = `
                    <div class="flex items-center justify-between cursor-pointer" onclick="window.panToUser('${user.id}')">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="w-10 h-10 rounded-full ${isCurrentUser ? 'bg-green-500' : 'bg-blue-500'} flex items-center justify-center font-bold text-sm text-white">${(user.name || 'A').charAt(0).toUpperCase()}</div>
                                <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full ${statusDotColor} border-2 border-white"></span>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">${user.name || 'Người dùng ẩn danh'} ${isCurrentUser ? '<span class="text-xs font-normal text-green-600">(Bạn)</span>' : ''}</p>
                                <p class="text-xs text-gray-500">${statusText}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 text-right">
                        <button id="load-history-${user.id}" onclick="window.loadAndDisplayFullPath('${user.id}')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-2 py-1 rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed">
                            Xem đầy đủ
                        </button>
                    </div>
                `;
                userList.appendChild(li);
            });
        }
        
        window.loadAndDisplayFullPath = async (userId) => {
            const button = document.getElementById(`load-history-${userId}`);
            button.textContent = 'Đang tải...';
            button.disabled = true;

            try {
                const userDocRef = doc(db, FIRESTORE_COLLECTION, userId);
                const archiveCollectionRef = collection(db, FIRESTORE_COLLECTION, userId, 'path_archives');
                const archiveQuery = query(archiveCollectionRef, orderBy("createdAt", "asc"));
                const [userDocSnap, archiveSnap] = await Promise.all([
                    getDoc(userDocRef),
                    getDocs(archiveQuery)
                ]);

                if (!userDocSnap.exists()) {
                    showNotification("Không tìm thấy dữ liệu người dùng.");
                    return;
                }

                const userData = userDocSnap.data();
                const archivedPath = archiveSnap.docs.flatMap(doc => doc.data().segment || []);
                const fullPath = [...archivedPath, ...(userData.path || [])];
                const updatedUserData = { ...userData, path: fullPath };
                updateUserOnMap(userId, updatedUserData);
                showNotification(`Đã tải toàn bộ lịch sử cho ${userData.name || 'Người dùng ẩn danh'}.`);
                button.textContent = 'Đã tải';
            } catch (error) {
                console.error(`Lỗi khi tải lịch sử cho ${userId}:`, error);
                showNotification("Không thể tải lịch sử. Vui lòng thử lại.");
                button.textContent = 'Thử lại';
                button.disabled = false;
            }
        };
        
        window.panToUser = (userId) => {
            if (mapObjects[userId] && mapObjects[userId].marker) {
                map.setView(mapObjects[userId].marker.getLatLng(), 16);
                mapObjects[userId].marker.openPopup();
            }
        };
        
        // --- Event Listeners ---
        startTrackingButton.addEventListener('click', () => {
            authStatus.textContent = 'Đang kết nối...';
            startTrackingButton.disabled = true;
            signInAnonymously(auth).catch((error) => {
                console.error("Lỗi đăng nhập ẩn danh:", error);
                authStatus.textContent = 'Xác thực thất bại. Vui lòng thử lại.';
                showNotification(`Lỗi xác thực: ${error.message}`);
                startTrackingButton.disabled = false;
            });
        });

        saveNameButton.addEventListener('click', () => {
            const newName = deviceNameInput.value.trim();
            if (newName) {
                localStorage.setItem('deviceName', newName);
                const userDocRef = doc(db, FIRESTORE_COLLECTION, currentUser.uid);
                updateDoc(userDocRef, { name: newName });
                showNotification(`Tên đã được lưu thành "${newName}".`);
            } else {
                 showNotification('Vui lòng nhập tên hợp lệ.');
            }
        });
        
        centerOnMeBtn.addEventListener('click', centerOnCurrentUser);
        fitAllUsersBtn.addEventListener('click', fitAllUsers);

        // --- Initialization ---
        function main() {
            try {
                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        const userDocRef = doc(db, FIRESTORE_COLLECTION, currentUser.uid);
                        const docSnap = await getDoc(userDocRef);
                        if (!docSnap.exists()) {
                            try {
                                await setDoc(userDocRef, {
                                    name: localStorage.getItem('deviceName') || 'Người dùng ẩn danh',
                                    timestamp: serverTimestamp(),
                                    path: [] 
                                });
                            } catch (error) {
                                console.error("Lỗi khi tạo tài liệu người dùng:", error);
                                return;
                            }
                        }
                        authStatus.textContent = 'Xác thực thành công!';
                        if(!appScreen.classList.contains('hidden')) return;
                        initializeAppLogic();
                    } else {
                        currentUser = null;
                        authScreen.classList.remove('hidden');
                        appScreen.classList.add('hidden');
                        authStatus.textContent = 'Sẵn sàng để bắt đầu.';
                        startTrackingButton.disabled = false;
                    }
                });
            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error);
                authStatus.textContent = "Lỗi khởi tạo. Kiểm tra console.";
            }
        }
        
        main();
        
    </script>
</body>
</html>
