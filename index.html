<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo Dõi Vị Trí Theo Nhóm - V4 (Room System)</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        html, body { height: 100%; }
        body { font-family: 'Inter', sans-serif; margin: 0; }
        .other-user-marker {
            background-color: #3b82f6; width: 1.5rem; height: 1.5rem; border-radius: 9999px;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 0.75rem; font-weight: bold;
        }
        .current-user-marker {
            background-color: #22c55e; width: 1.75rem; height: 1.75rem; border-radius: 9999px;
            border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #map { height: 100%; width: 100%; border-radius: 0.75rem; }
        .leaflet-pane { z-index: 1; }
        .leaflet-top, .leaflet-bottom { z-index: 2; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Landing Screen: Shown on page load if no room ID is in URL -->
    <div id="landing-screen" class="min-h-screen flex flex-col items-center justify-center p-4 text-center bg-white">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Theo Dõi Nhóm</h1>
        <p class="text-lg text-gray-600 mb-10 max-w-2xl">
            Tạo một phòng theo dõi riêng tư để chia sẻ vị trí với bạn bè hoặc tham gia một phòng đã có.
        </p>
        <div class="w-full max-w-md space-y-4">
            <button id="create-room-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg">
                Tạo Phòng Mới
            </button>
            <div class="relative flex items-center">
                <hr class="w-full border-gray-300">
                <span class="absolute left-1/2 -translate-x-1/2 bg-white px-2 text-sm text-gray-500">HOẶC</span>
            </div>
            <div class="space-y-2">
                <input type="text" id="room-id-input" placeholder="Nhập ID phòng..." class="w-full text-center bg-white border border-gray-300 rounded-md px-3 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="join-room-button" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg text-md transition">
                    Tham Gia Phòng
                </button>
            </div>
        </div>
        <p id="landing-status" class="mt-6 text-gray-500 text-sm"></p>
    </div>

    <!-- Main Application Screen: Hidden until in a room and authenticated -->
    <div id="app-screen" class="hidden min-h-screen w-full p-2 md:p-4">
        <div class="flex flex-col md:grid md:grid-cols-3 lg:grid-cols-4 gap-4 md:h-[calc(100vh-2rem)]">

            <!-- Left Panel: Controls & Info -->
            <div class="md:col-span-1 lg:col-span-1 bg-white rounded-xl shadow p-4 flex flex-col md:overflow-y-auto">
                <div>
                    <h2 class="text-2xl font-bold mb-2 text-gray-900">Bảng điều khiển</h2>
                    
                    <!-- NEW: Room ID Display -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <h3 class="font-semibold text-sm mb-1 text-blue-800">ID Phòng (Chia sẻ cho bạn bè)</h3>
                        <div class="flex items-center gap-2">
                            <input id="room-id-display" class="font-mono text-blue-900 bg-transparent w-full" readonly>
                            <button id="copy-room-id-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-3 py-1 rounded-md text-sm transition">Chép</button>
                        </div>
                    </div>

                    <p class="text-xs text-gray-500 mb-4 break-all">ID của bạn: <span id="user-id-display" class="font-mono"></span></p>

                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
                        <h3 class="font-semibold text-lg mb-2 text-gray-800">Thông tin của bạn</h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <p>Trạng thái: <span id="location-status" class="font-medium text-yellow-600">Đang lấy vị trí...</span></p>
                            <p>Vĩ độ: <span id="lat-display" class="font-mono text-green-600">N/A</span></p>
                            <p>Kinh độ: <span id="lng-display" class="font-mono text-green-600">N/A</span></p>
                            <p>Tốc độ: <span id="speed-display" class="font-mono text-green-600">0</span> km/h</p>
                        </div>
                    </div>

                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
                         <h3 class="font-semibold text-lg mb-2 text-gray-800">Tên hiển thị</h3>
                         <div class="flex gap-2">
                            <input type="text" id="device-name-input" placeholder="Nhập tên của bạn..." class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="save-name-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 rounded-md text-sm transition">Lưu</button>
                         </div>
                    </div>
                </div>

                <div class="flex flex-col min-h-0">
                    <h3 class="font-semibold text-lg mb-2 text-gray-800">Thành viên trong phòng</h3>
                    <div id="user-list-container" class="bg-gray-50 border border-gray-200 rounded-lg p-3 overflow-y-auto min-h-[250px]">
                        <ul id="user-list" class="space-y-3"></ul>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Map -->
            <div class="md:col-span-2 lg:col-span-3 bg-white rounded-xl shadow p-1 md:p-2 h-[65vh] md:h-auto">
                <div id="map"></div>
            </div>
        </div>
    </div>
    
    <div id="notification-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="notification-message" class="text-lg mb-4 text-gray-800"></p>
            <button onclick="document.getElementById('notification-modal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-md">Đã hiểu</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, updateDoc, arrayUnion, getDoc, addDoc, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyABC...",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef123456"
        };
        const PATH_ARCHIVE_THRESHOLD = 50;
        const OFFLINE_THRESHOLD_MINUTES = 2;

        // --- DOM Elements ---
        const landingScreen = document.getElementById('landing-screen');
        const createRoomButton = document.getElementById('create-room-button');
        const roomIdInput = document.getElementById('room-id-input');
        const joinRoomButton = document.getElementById('join-room-button');
        const landingStatus = document.getElementById('landing-status');
        
        const appScreen = document.getElementById('app-screen');
        const mapElement = document.getElementById('map');
        const roomIdDisplay = document.getElementById('room-id-display');
        const copyRoomIdButton = document.getElementById('copy-room-id-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const locationStatus = document.getElementById('location-status');
        const latDisplay = document.getElementById('lat-display');
        const lngDisplay = document.getElementById('lng-display');
        const speedDisplay = document.getElementById('speed-display');
        const deviceNameInput = document.getElementById('device-name-input');
        const saveNameButton = document.getElementById('save-name-button');
        const userList = document.getElementById('user-list');
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        
        // --- Global State ---
        let db, auth, firebaseApp;
        let currentUser = null;
        let currentRoomId = null; // NEW: Holds the ID of the current room
        let map = null;
        let mapObjects = {};
        let lastPosition = null;
        const speedReadings = [];
        let authStateUnsubscribe = null; // To detach the listener

        // --- Utility Functions ---
        const showNotification = (message) => {
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        };

        const generateRoomId = () => {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        };

        // --- Room & URL Handling ---
        const handleCreateRoom = () => {
            const newRoomId = generateRoomId();
            landingStatus.textContent = `Đang tạo phòng ${newRoomId}...`;
            window.location.href = `${window.location.pathname}?room=${newRoomId}`;
        };

        const handleJoinRoom = () => {
            const roomId = roomIdInput.value.trim().toUpperCase();
            if (roomId.length < 5) {
                showNotification("ID phòng không hợp lệ. Vui lòng kiểm tra lại.");
                return;
            }
            landingStatus.textContent = `Đang tham gia phòng ${roomId}...`;
            window.location.href = `${window.location.pathname}?room=${roomId}`;
        };

        // --- Core Application Logic ---
        const initializeAppLogic = () => {
            landingScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            
            roomIdDisplay.value = currentRoomId;
            userIdDisplay.textContent = currentUser.uid;
            deviceNameInput.value = localStorage.getItem('deviceName') || '';

            initializeMap();
            startWatchingLocation();
            startListeningToOtherUsers();
        };

        const initializeMap = () => { /* ... (same as before) ... */ };
        // ... (other functions like calculateAndSmoothSpeed, removeUserFromMap, etc. remain mostly the same)
        const calculateAndSmoothSpeed = (newPosition) => {
             if (!lastPosition) {
                lastPosition = newPosition;
                return 0;
            }

            const distanceMeters = L.latLng(lastPosition.coords.latitude, lastPosition.coords.longitude)
                .distanceTo(L.latLng(newPosition.coords.latitude, newPosition.coords.longitude));
            
            const timeSeconds = (newPosition.timestamp - lastPosition.timestamp) / 1000;

            if (timeSeconds <= 0) {
                 lastPosition = newPosition;
                 return speedReadings.length > 0 ? speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length : 0;
            }

            const speedMs = distanceMeters / timeSeconds;
            const speedKmh = speedMs * 3.6;

            speedReadings.push(speedKmh);
            if (speedReadings.length > 5) { // SMOOTHING_FACTOR
                speedReadings.shift(); 
            }

            const smoothedSpeed = speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length;
            lastPosition = newPosition; 
            
            return smoothedSpeed;
        }

        const startWatchingLocation = () => {
             if (!navigator.geolocation) {
                locationStatus.textContent = 'Trình duyệt không hỗ trợ';
                showNotification('Trình duyệt của bạn không hỗ trợ Geolocation.');
                return;
            }

            navigator.geolocation.watchPosition(
                (position) => {
                    locationStatus.textContent = 'Đang hoạt động';
                    locationStatus.classList.remove('text-yellow-600');
                    locationStatus.classList.add('text-green-600');
                    const { latitude, longitude } = position.coords;
                    const calculatedSpeedKmh = calculateAndSmoothSpeed(position);

                    latDisplay.textContent = latitude.toFixed(5);
                    lngDisplay.textContent = longitude.toFixed(5);
                    speedDisplay.textContent = calculatedSpeedKmh.toFixed(1);
                    
                    updateLocationInFirestore({ latitude, longitude, speedKmh: calculatedSpeedKmh });
                },
                (error) => { /* ... error handling ... */ },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        };

        /**
         * UPDATED: Firestore paths now use 'currentRoomId'
         */
        const updateLocationInFirestore = async ({ latitude, longitude, speedKmh }) => {
            if (!db || !currentUser || !currentRoomId) return;

            const usersCollectionPath = `artifacts/public/data/rooms/${currentRoomId}/users`;
            const userDocRef = doc(db, usersCollectionPath, currentUser.uid);
            const newPoint = { lat: latitude, lng: longitude };

            try {
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) return;
                
                const currentPath = docSnap.data().path || [];

                if (currentPath.length >= PATH_ARCHIVE_THRESHOLD) {
                    const newPath = [currentPath[currentPath.length - 1], newPoint];
                    const archiveCollectionRef = collection(db, usersCollectionPath, currentUser.uid, 'path_archives');
                    await addDoc(archiveCollectionRef, { segment: currentPath, createdAt: serverTimestamp() });
                    await updateDoc(userDocRef, {
                        name: deviceNameInput.value.trim() || 'Người dùng ẩn danh',
                        timestamp: serverTimestamp(),
                        lastSpeed: speedKmh,
                        path: newPath
                    });
                } else {
                    await updateDoc(userDocRef, {
                        name: deviceNameInput.value.trim() || 'Người dùng ẩn danh',
                        timestamp: serverTimestamp(),
                        lastSpeed: speedKmh,
                        path: arrayUnion(newPoint)
                    });
                }
            } catch (error) {
                console.error("Lỗi khi cập nhật vị trí (pruning):", error);
            }
        };

        /**
         * UPDATED: Firestore paths now use 'currentRoomId'
         */
        const startListeningToOtherUsers = () => {
            if (!db || !currentRoomId) return;
            const usersCollection = collection(db, `artifacts/public/data/rooms/${currentRoomId}/users`);
            onSnapshot(usersCollection, (snapshot) => {
                const activeUsers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                const activeUserIds = new Set(activeUsers.map(u => u.id));
                activeUsers.forEach(user => updateUserOnMap(user.id, user));
                Object.keys(mapObjects).forEach(userId => {
                    if (!activeUserIds.has(userId)) removeUserFromMap(userId);
                });
                updateUserListUI(activeUsers);
            }, (error) => console.error("Lỗi snapshot:", error));
        };
        
        const updateUserOnMap = (userId, userData) => { /* ... (same as before) ... */ };
        const removeUserFromMap = (userId) => { /* ... (same as before) ... */ };
        const updateUserListUI = (users) => { /* ... (same as before) ... */ };


        /**
         * NEW: Main initialization logic driven by URL
         */
        const main = () => {
            // Initialize Firebase App
            firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            auth = getAuth(firebaseApp);

            // Check for room ID in the URL
            const urlParams = new URLSearchParams(window.location.search);
            currentRoomId = urlParams.get('room');

            if (currentRoomId) {
                // User is in a room, proceed to authentication and app logic
                landingScreen.classList.add('hidden'); // Hide landing screen
                document.title = `Phòng: ${currentRoomId}`; // Update page title

                // Listen for authentication state changes
                authStateUnsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        currentUser = user;

                        // Check if user document exists, create if not
                        const userDocRef = doc(db, `artifacts/public/data/rooms/${currentRoomId}/users`, currentUser.uid);
                        const docSnap = await getDoc(userDocRef);
                        if (!docSnap.exists()) {
                            await setDoc(userDocRef, {
                                name: localStorage.getItem('deviceName') || 'Người dùng ẩn danh',
                                timestamp: serverTimestamp(),
                                path: []
                            });
                        }
                        
                        // If app screen is already visible, do nothing
                        if(!appScreen.classList.contains('hidden')) return;

                        initializeAppLogic();

                    } else {
                        // User is not signed in, sign in anonymously
                        signInAnonymously(auth).catch((error) => {
                            console.error("Lỗi đăng nhập ẩn danh:", error);
                            showNotification(`Không thể tham gia phòng: ${error.message}`);
                        });
                    }
                });

            } else {
                // No room ID in URL, show the landing page
                landingScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                
                // Set up landing page buttons
                createRoomButton.addEventListener('click', handleCreateRoom);
                joinRoomButton.addEventListener('click', handleJoinRoom);
            }

            // --- Event Listeners for App Screen ---
            saveNameButton.addEventListener('click', () => {
                const newName = deviceNameInput.value.trim();
                if (newName) {
                    localStorage.setItem('deviceName', newName);
                    const userDocRef = doc(db, `artifacts/public/data/rooms/${currentRoomId}/users`, currentUser.uid);
                    updateDoc(userDocRef, { name: newName });
                    showNotification(`Tên đã được lưu thành "${newName}".`);
                }
            });

            copyRoomIdButton.addEventListener('click', () => {
                navigator.clipboard.writeText(currentRoomId).then(() => {
                    showNotification(`Đã chép ID Phòng: ${currentRoomId}`);
                }).catch(err => {
                    showNotification('Lỗi khi chép ID.');
                });
            });
        };

        // Run the app
        main();

    </script>
</body>
</html>
