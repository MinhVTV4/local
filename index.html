<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo Dõi Vị Trí Thời Gian Thực - V2</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to complement Tailwind */
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
        }
        .current-user-marker {
            background-color: #22c55e; /* bg-green-500 */
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 9999px;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .other-user-marker {
            background-color: #3b82f6; /* bg-blue-500 */
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
        }
        .leaflet-pane { z-index: 1; }
        .leaflet-top, .leaflet-bottom { z-index: 2; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Authentication Screen -->
    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center p-4 text-center bg-white">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Chào mừng bạn!</h1>
        <p class="text-lg text-gray-600 mb-8 max-w-2xl">
            Bắt đầu chia sẻ vị trí của bạn và xem những người khác trên bản đồ. Hành trình của bạn sẽ được tự động ghi lại.
        </p>
        <button id="start-tracking-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg">
            Bắt đầu Theo dõi
        </button>
        <p id="auth-status" class="mt-4 text-gray-500 text-sm">Đang chờ xác thực...</p>
    </div>

    <!-- Main Application Screen -->
    <div id="app-screen" class="hidden min-h-screen w-full p-2 md:p-4">
        <div class="flex flex-col md:grid md:grid-cols-3 lg:grid-cols-4 gap-4 md:h-[calc(100vh-2rem)]">

            <!-- Left Panel -->
            <div class="md:col-span-1 lg:col-span-1 bg-white rounded-xl shadow p-4 flex flex-col md:overflow-y-auto">
                <div>
                    <h2 class="text-2xl font-bold mb-1 text-gray-900">Bảng điều khiển</h2>
                    <p class="text-xs text-gray-500 mb-4 break-all">ID của bạn: <span id="user-id-display" class="font-mono"></span></p>

                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
                        <h3 class="font-semibold text-lg mb-2 text-gray-800">Thông tin của bạn</h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <p>Trạng thái: <span id="location-status" class="font-medium text-yellow-600">Đang lấy vị trí...</span></p>
                            <p>Tốc độ: <span id="speed-display" class="font-mono text-green-600">0</span> km/h</p>
                        </div>
                    </div>
                     <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
                        <h3 class="font-semibold text-lg mb-2 text-gray-800">Tên hiển thị</h3>
                        <div class="flex gap-2">
                           <input type="text" id="device-name-input" placeholder="Nhập tên của bạn..." class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                           <button id="save-name-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 rounded-md text-sm transition">Lưu</button>
                        </div>
                     </div>
                     <button id="history-button" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mb-4">
                        Xem Lịch sử Hành trình
                     </button>
                </div>
                
                <!-- Active Users List -->
                <div class="flex flex-col flex-grow min-h-0">
                    <h3 class="font-semibold text-lg mb-2 text-gray-800">Người dùng đang hoạt động</h3>
                    <div id="user-list-container" class="bg-gray-50 border border-gray-200 rounded-lg p-3 overflow-y-auto flex-grow min-h-[250px]">
                        <ul id="user-list" class="space-y-3">
                           <li class="text-gray-500 text-sm">Đang chờ người dùng khác...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="md:col-span-2 lg:col-span-3 bg-white rounded-xl shadow p-1 md:p-2 h-[65vh] md:h-auto">
                <div id="map"></div>
            </div>
        </div>
    </div>
    
    <!-- Journey History Modal -->
    <div id="history-modal" class="hidden fixed inset-0 bg-black/60 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Lịch sử Hành trình</h2>
                <button id="close-history-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="journeys-list-container" class="overflow-y-auto flex-grow">
                 <ul id="journeys-list" class="space-y-3 text-left">
                    <li class="text-gray-500 text-sm text-center">Chưa có hành trình nào được ghi lại.</li>
                 </ul>
            </div>
        </div>
    </div>

    <!-- General Notification Modal -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="notification-message" class="text-lg mb-4 text-gray-800"></p>
            <button onclick="document.getElementById('notification-modal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-md">Đã hiểu</button>
        </div>
    </div>


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Firebase JS SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, updateDoc, arrayUnion, getDoc, addDoc, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Config ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'location-tracker-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD3ZZT39FFnPINSnwXmFTFYLuUUoubHGiA",
            authDomain: "ailocal-86167.firebaseapp.com",
            projectId: "ailocal-86167",
            storageBucket: "ailocal-86167.firebasestorage.app",
            messagingSenderId: "303592611625",
            appId: "1:303592611625:web:ec5967ec4e6f8bbc00e138"
        };
        const SMOOTHING_FACTOR = 5; 
        const JOURNEY_BREAK_THRESHOLD_MINUTES = 10;
        const OFFLINE_THRESHOLD_MINUTES = 2;
        
        // --- Firestore Collections ---
        const LIVE_LOCATIONS_COLLECTION = `artifacts/${appId}/public/data/live_locations`;
        const USERS_COLLECTION = `artifacts/${appId}/public/data/users`;

        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen'), appScreen = document.getElementById('app-screen');
        const startTrackingButton = document.getElementById('start-tracking-button'), authStatus = document.getElementById('auth-status');
        const mapElement = document.getElementById('map'), userIdDisplay = document.getElementById('user-id-display');
        const locationStatus = document.getElementById('location-status'), speedDisplay = document.getElementById('speed-display');
        const deviceNameInput = document.getElementById('device-name-input'), saveNameButton = document.getElementById('save-name-button');
        const userList = document.getElementById('user-list');
        const historyButton = document.getElementById('history-button'), historyModal = document.getElementById('history-modal');
        const closeHistoryModal = document.getElementById('close-history-modal'), journeysList = document.getElementById('journeys-list');
        const notificationModal = document.getElementById('notification-modal'), notificationMessage = document.getElementById('notification-message');
        
        // --- Global State ---
        let db, auth, currentUser = null, map = null;
        let mapObjects = {}; // { userId: { marker, polyline } }
        let currentJourneyId = null, lastPosition = null;
        const speedReadings = [];
        let historicalPolyline = null;

        // --- Utility Functions ---
        const showNotification = (message) => { notificationMessage.textContent = message; notificationModal.classList.remove('hidden'); };
        const formatTimeAgo = (timestamp) => {
            if (!timestamp) return 'không rõ';
            const now = new Date(), seconds = Math.floor((now - timestamp.toDate()) / 1000);
            if (seconds < 60) return 'vừa xong';
            let interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + " giờ trước";
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + " phút trước";
            return 'vừa xong';
        };

        // --- Core App Logic ---

        const initializeAppLogic = () => {
            userIdDisplay.textContent = currentUser.uid;
            deviceNameInput.value = localStorage.getItem(`deviceName_${currentUser.uid}`) || '';
            authScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            initializeMap();
            startWatchingLocation();
            startListeningToOtherUsers();
            setupInactiveUserCleanup();
        };

        const initializeMap = () => {
            if (map) return;
            map = L.map(mapElement, { zoomControl: false }).setView([21.0285, 105.8542], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors', maxZoom: 19
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
        };
        
        // --- Real-time Location & Journey Logic ---

        const calculateAndSmoothSpeed = (newPosition) => {
            if (!lastPosition) { lastPosition = newPosition; return 0; }
            const distanceMeters = L.latLng(lastPosition.coords, newPosition.coords).distanceTo(L.latLng(newPosition.coords));
            const timeSeconds = (newPosition.timestamp - lastPosition.timestamp) / 1000;
            if (timeSeconds <= 0) {
                lastPosition = newPosition;
                return speedReadings.length > 0 ? speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length : 0;
            }
            const speedKmh = (distanceMeters / timeSeconds) * 3.6;
            speedReadings.push(speedKmh);
            if (speedReadings.length > SMOOTHING_FACTOR) speedReadings.shift();
            const smoothedSpeed = speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length;
            lastPosition = newPosition;
            return smoothedSpeed;
        };

        const handleLocationUpdate = async (position) => {
            locationStatus.textContent = 'Đang hoạt động';
            const { latitude, longitude } = position.coords;
            const speedKmh = calculateAndSmoothSpeed(position);
            speedDisplay.textContent = speedKmh.toFixed(1);

            // 1. Update live location for everyone to see
            const liveDocRef = doc(db, LIVE_LOCATIONS_COLLECTION, currentUser.uid);
            await setDoc(liveDocRef, {
                name: deviceNameInput.value.trim() || 'Người dùng ẩn danh',
                lat: latitude, lng: longitude, speed: speedKmh,
                timestamp: serverTimestamp()
            });

            // 2. Log to personal journey history in the background
            const timeSinceLastUpdate = lastPosition ? (position.timestamp - lastPosition.timestamp) / 1000 / 60 : 0;
            if (!currentJourneyId || timeSinceLastUpdate > JOURNEY_BREAK_THRESHOLD_MINUTES) {
                const journeysCollectionRef = collection(db, USERS_COLLECTION, currentUser.uid, "journeys");
                const docRef = await addDoc(journeysCollectionRef, { startTime: serverTimestamp(), path: [{ lat: latitude, lng: longitude }] });
                currentJourneyId = docRef.id;
            } else {
                const journeyDocRef = doc(db, USERS_COLLECTION, currentUser.uid, "journeys", currentJourneyId);
                await updateDoc(journeyDocRef, { path: arrayUnion({ lat: latitude, lng: longitude }) });
            }
        };

        const startWatchingLocation = () => {
            if (!navigator.geolocation) {
                locationStatus.textContent = 'Trình duyệt không hỗ trợ';
                return showNotification('Trình duyệt của bạn không hỗ trợ Geolocation.');
            }
            navigator.geolocation.watchPosition(handleLocationUpdate, (error) => {
                locationStatus.textContent = 'Lỗi vị trí';
                showNotification('Không thể lấy vị trí. Vui lòng kiểm tra quyền truy cập.');
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        };
        
        // --- UI & Map Drawing Logic ---

        const startListeningToOtherUsers = () => {
            const q = query(collection(db, LIVE_LOCATIONS_COLLECTION));
            onSnapshot(q, (snapshot) => {
                const activeUserIds = new Set();
                snapshot.forEach(doc => {
                    activeUserIds.add(doc.id);
                    updateUserOnMap(doc.id, doc.data());
                });
                Object.keys(mapObjects).forEach(userId => {
                    if (!activeUserIds.has(userId)) removeUserFromMap(userId);
                });
                updateUserListUI(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
            });
        };

        const updateUserOnMap = (userId, userData) => {
            const latLng = [userData.lat, userData.lng];
            const isCurrentUser = userId === currentUser.uid;
            if (!mapObjects[userId]) mapObjects[userId] = { marker: null };

            const iconClass = isCurrentUser ? 'current-user-marker' : 'other-user-marker';
            const icon = L.divIcon({ className: iconClass, iconSize: [isCurrentUser ? 28 : 24, isCurrentUser ? 28 : 24] });
            
            if (mapObjects[userId].marker) {
                mapObjects[userId].marker.setLatLng(latLng).setIcon(icon);
            } else {
                mapObjects[userId].marker = L.marker(latLng, { icon }).addTo(map);
                if (isCurrentUser) map.setView(latLng, 15);
            }
        };

        const removeUserFromMap = (userId) => {
            if (mapObjects[userId]?.marker) map.removeLayer(mapObjects[userId].marker);
            delete mapObjects[userId];
        };

        const updateUserListUI = (users) => {
            userList.innerHTML = '';
            const now = Date.now();
            users.sort((a,b) => (a.name || '').localeCompare(b.name || ''));

            if(users.length === 0) {
                 userList.innerHTML = '<li class="text-gray-500 text-sm">Chưa có người dùng nào khác.</li>';
                 return;
            }

            users.forEach(user => {
                const isCurrentUser = user.id === currentUser.uid;
                const isOnline = user.timestamp ? (now - user.timestamp.toDate().getTime()) < OFFLINE_THRESHOLD_MINUTES * 60 * 1000 : false;
                const li = document.createElement('li');
                li.className = `flex items-center justify-between p-2 rounded-md transition ${isCurrentUser ? 'bg-blue-50' : 'hover:bg-gray-100'} ${!isOnline && !isCurrentUser ? 'opacity-60' : ''} cursor-pointer`;
                li.onclick = () => mapObjects[user.id]?.marker && map.setView(mapObjects[user.id].marker.getLatLng(), 16);
                
                const statusDotColor = isOnline ? 'bg-green-500' : 'bg-gray-400';
                const statusText = isOnline ? `Tốc độ: ${user.speed?.toFixed(1) || 0} km/h` : `Hoạt động ${formatTimeAgo(user.timestamp)}`;

                li.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <div class="w-10 h-10 rounded-full ${isCurrentUser ? 'bg-green-500' : 'bg-blue-500'} flex items-center justify-center font-bold text-sm text-white">${(user.name || 'A').charAt(0).toUpperCase()}</div>
                            <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full ${statusDotColor} border-2 border-white"></span>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${user.name || 'Người dùng ẩn danh'} ${isCurrentUser ? '<span class="text-xs font-normal text-green-600">(Bạn)</span>' : ''}</p>
                            <p class="text-xs text-gray-500">${statusText}</p>
                        </div>
                    </div>`;
                userList.appendChild(li);
            });
        };
        
        // --- History Modal Logic ---
        
        const openHistoryModal = async () => {
            const journeysCollectionRef = collection(db, USERS_COLLECTION, currentUser.uid, "journeys");
            const q = query(journeysCollectionRef, orderBy("startTime", "desc"));
            const snapshot = await getDocs(q);

            journeysList.innerHTML = '';
            if (snapshot.empty) {
                journeysList.innerHTML = '<li class="text-gray-500 text-sm text-center">Chưa có hành trình nào được ghi lại.</li>';
            } else {
                snapshot.forEach(doc => {
                    const journey = doc.data();
                    const li = document.createElement('li');
                    li.className = 'p-3 rounded-md hover:bg-gray-100 cursor-pointer border-b';
                    li.onclick = () => {
                        if (historicalPolyline) map.removeLayer(historicalPolyline);
                        const path = journey.path.map(p => [p.lat, p.lng]);
                        historicalPolyline = L.polyline(path, { color: '#8b5cf6', weight: 5 }).addTo(map);
                        map.fitBounds(historicalPolyline.getBounds());
                        historyModal.classList.add('hidden');
                    };
                    const startTime = journey.startTime?.toDate();
                    li.innerHTML = `
                        <p class="font-semibold">Bắt đầu: ${startTime ? startTime.toLocaleString('vi-VN') : 'N/A'}</p>
                        <p class="text-xs text-gray-600">${journey.path.length} điểm được ghi lại</p>
                    `;
                    journeysList.appendChild(li);
                });
            }
            historyModal.classList.remove('hidden');
        };

        const setupInactiveUserCleanup = () => {
            window.addEventListener('beforeunload', () => {
                if (!auth.currentUser) return;
                const liveDocRef = doc(db, LIVE_LOCATIONS_COLLECTION, auth.currentUser.uid);
                deleteDoc(liveDocRef);
            });
        };

        // --- Event Listeners & Init ---

        startTrackingButton.addEventListener('click', () => {
            authStatus.textContent = 'Đang kết nối...';
            startTrackingButton.disabled = true;
            signInAnonymously(auth).catch((error) => {
                authStatus.textContent = 'Xác thực thất bại.';
                showNotification(`Lỗi xác thực: ${error.message}`);
                startTrackingButton.disabled = false;
            });
        });

        saveNameButton.addEventListener('click', async () => {
            const newName = deviceNameInput.value.trim();
            if (newName) {
                localStorage.setItem(`deviceName_${currentUser.uid}`, newName);
                const userDocRef = doc(db, USERS_COLLECTION, currentUser.uid);
                await setDoc(userDocRef, { name: newName }, { merge: true });
                showNotification(`Tên đã được lưu thành "${newName}".`);
            }
        });

        historyButton.addEventListener('click', openHistoryModal);
        closeHistoryModal.addEventListener('click', () => {
             historyModal.classList.add('hidden');
             if (historicalPolyline) {
                map.removeLayer(historicalPolyline);
                historicalPolyline = null;
             }
        });

        function main() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        const userDocRef = doc(db, USERS_COLLECTION, currentUser.uid);
                        const docSnap = await getDoc(userDocRef);
                        if (!docSnap.exists()) {
                            await setDoc(userDocRef, { 
                                name: localStorage.getItem(`deviceName_${currentUser.uid}`) || 'Người dùng ẩn danh',
                                created: serverTimestamp()
                            });
                        } else if (docSnap.data().name) {
                             deviceNameInput.value = docSnap.data().name;
                        }
                        if(!appScreen.classList.contains('hidden')) return;
                        initializeAppLogic();
                    } else {
                        currentUser = null;
                        authScreen.classList.remove('hidden');
                        appScreen.classList.add('hidden');
                        authStatus.textContent = 'Sẵn sàng để bắt đầu.';
                        startTrackingButton.disabled = false;
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                authStatus.textContent = "Lỗi khởi tạo.";
                showNotification(`Không thể khởi tạo ứng dụng: ${error.message}`);
            }
        }
        main();
        
    </script>
</body>
</html>
